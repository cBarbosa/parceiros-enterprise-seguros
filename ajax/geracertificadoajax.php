<?phpsession_start();require_once('../inc/EnterpriseWS.php');
if(!isset($_SESSION['user'])){	echo false;	exit;}
$cpf			= $_GET["val-cpfcliente"];$certificado	= $_GET["val-certificado"];
if(!isset($_GET["val-cpfcliente"]) || !isset($_GET["val-certificado"])){	header("Content-Type: text/html; charset=utf-8");	echo("<ul>");	echo("<li>Cod 99</li>");	echo("<li>Não foi possível gerar o certificado.</li>");	echo("</ul>");	exit;}
$xml = "<sgsm:GetCertificadoPDF>			<sgsm:cpf>$cpf</sgsm:cpf>			<sgsm:certificado>$certificado</sgsm:certificado>		</sgsm:GetCertificadoPDF>";
$obj = new EnterpriseWS();$obj->setEnterpriseWSUser($_SESSION['user']->loginname, $_SESSION['user']->password);
try {	$response = $obj->GetCertificadoPDFNOSHOW($xml);	$response = str_replace("</soap:Body>","",str_replace("<soap:Body>","",$response));	$response = simplexml_load_string($response);	if(isset($response->GetCertificadoPDFResponse->GetCertificadoPDFResult->CodigoRetorno))	{		if(strval($response->GetCertificadoPDFResponse->GetCertificadoPDFResult->CodigoRetorno)=="0")		{			header("Content-type: application/pdf");			header("Content-Disposition: attachment; filename=certificado_$certificado.pdf");			$base64 = strval($response->GetCertificadoPDFResponse->GetCertificadoPDFResult->Documento);			$binary = base64_decode($base64);			file_put_contents("certificado_$certificado.pdf", $binary);			echo $binary;		} else {			header("Content-Type: text/html; charset=utf-8");			echo("<ul>");			echo("<li>COD: ".strval($response->GetCertificadoPDFResponse->GetCertificadoPDFResult->CodigoRetorno)."</li>");			echo("<li>".strval($response->GetCertificadoPDFResponse->GetCertificadoPDFResult->MensagemAmigavel)."</li>");			echo("</ul>");		}	} else {		header("Content-Type: text/html; charset=utf-8");		echo("<ul>");		echo("<li>Cod 99</li>");		echo("<li>Não foi possível gerar o certificado.</li>");		echo("</ul>");	}}  catch (Exception $e) {	header("Content-Type: text/html; charset=utf-8");	echo "Exceção: ",  $e->getMessage(), "\n";}?>