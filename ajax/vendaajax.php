<?phpsession_start();require_once('../inc/EnterpriseWS.php');header('Content-type: text/json');header('Content-type: application/json');
if(!isset($_SESSION['user'])){	echo json_encode(false);	exit;}//var_dump($_POST);exit;// Dados do Evento$evento			= $_POST["val-evento"];$valor			= str_replace(",", ".", $_POST["val-vingresso"]);$valor			= strpos($valor, ".") > 0 ? $valor : $valor.".0";$ingresso		= $_POST["val-ingresso"];$premio			= $_POST["val-premiocalc"];
if(isset($_POST["val-tipoingresso"]))	$tipoingresso	= $_POST["val-tipoingresso"];// Dados Pessoais$email			= $_POST["val-mail"];$nome			= $_POST["val-nome"];$cpfCliente		= $_POST["val-cpfcliente"];$datanascimento = explode('/', $_POST["val-nascimento"]);$datanascimento = $datanascimento[2] .'-'. $datanascimento[1] .'-'. $datanascimento[0] ."T00:00:00";$estCivil		= $_POST["val-estadocivil"];$sexo			= $_POST["val-sexo"];$rg				= $_POST["val-documento"];$expeditor		= $_POST["val-expeditor"];$ufexpeditor	= $_POST["val-ufexpeditor"];if(!isset($_POST["val-dataexpedicao"])){	if($_POST["val-dataexpedicao"]!='')	{		$dataexpedicao	= explode('/', $_POST["val-dataexpedicao"]);		$dataexpedicao	= $dataexpedicao[2] .'-'. $dataexpedicao[1] .'-'. $dataexpedicao[0] ."T00:00:00";	} else		$dataexpedicao = '';} else 	$dataexpedicao = '';// Dados de endereço$logradouro		= $_POST["val-logradouro"];$complemento	= $_POST["val-logradouro2"];$numero			= $_POST["val-logradouron"];$bairro			= $_POST["val-logradourob"];$cidade			= $_POST["val-logradouroc"];$cep			= $_POST["val-cep"];$uf				= $_POST["val-uf"];$xml = "<sgsm:RealizaVenda>         <sgsm:listProposta>            <sgsm:DadosProposta>               <sgsm:CodigoEvento>$evento</sgsm:CodigoEvento>               <sgsm:ValorImportanciaSegurada>$valor</sgsm:ValorImportanciaSegurada>               <sgsm:ValorPremio>$premio</sgsm:ValorPremio>               <sgsm:CodigoProduto>523</sgsm:CodigoProduto>               <sgsm:NumeroIngresso>$ingresso</sgsm:NumeroIngresso>               <sgsm:IDCanalVenda>1</sgsm:IDCanalVenda>               <sgsm:IDOrigemVenda>2</sgsm:IDOrigemVenda>            </sgsm:DadosProposta>         </sgsm:listProposta>         <sgsm:cliente>";if($email!="")	$xml .= "<sgsm:Email>$email</sgsm:Email>";$xml .= "<sgsm:Nome>$nome</sgsm:Nome>            <sgsm:CPF>$cpfCliente</sgsm:CPF>            <sgsm:EstadoCivil>$estCivil</sgsm:EstadoCivil>            <sgsm:Sexo>$sexo</sgsm:Sexo>            <sgsm:DataNascimento>$datanascimento</sgsm:DataNascimento>";if($rg != "")	$xml .= "<sgsm:NumeroRG>$rg</sgsm:NumeroRG>";if($expeditor != "")	$xml .= "<sgsm:OrgaoExpedidor>$expeditor</sgsm:OrgaoExpedidor>";if($dataexpedicao != "")	$xml .= "<sgsm:DataExpedicao>$dataexpedicao</sgsm:DataExpedicao>";if($ufexpeditor != "")	$xml .= "<sgsm:IDUFOrgaoExpedidor>$ufexpeditor</sgsm:IDUFOrgaoExpedidor>";$xml .= "<sgsm:TipoEndereco>2</sgsm:TipoEndereco>            <sgsm:Logradouro>$logradouro</sgsm:Logradouro>            <sgsm:Bairro>$bairro</sgsm:Bairro>            <sgsm:Cidade>$cidade</sgsm:Cidade>            <sgsm:CEP>$cep</sgsm:CEP>            <sgsm:Numero>$numero</sgsm:Numero>            <sgsm:Complemento>$complemento</sgsm:Complemento>            <sgsm:IDUF>$uf</sgsm:IDUF>         </sgsm:cliente>		 <sgsm:enviaEmail>false</sgsm:enviaEmail>      </sgsm:RealizaVenda>";//var_dump($xml);exit;
$obj = new EnterpriseWS();$obj->setEnterpriseWSUser($_SESSION['user']->loginname, $_SESSION['user']->password);
try {	$response = $obj->VendaMicroSeguroNOSHOW($xml);
	$response = str_replace("</soap:Body>","",str_replace("<soap:Body>","",$response));	$response = simplexml_load_string($response);//var_dump($response);exit;	if(isset($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->CodRetorno))	{		$json_str =array("CodRetorno"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->CodRetorno),										"Mensagem"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->DescricaoRetorno),										"NumeroIngresso"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->NumeroIngresso),										"NumeroSorte"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->NumeroSorte),										"NumeroSerieSorte"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->NumeroSerieSorte),										"ValorPremio"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->ValorPremio),										"NumeroProposta"=>strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->NumeroProposta)									);		if(strval($response->RealizaVendaResponse->RealizaVendaResult->RetornoOperacao->CodRetorno)!="0")		{			$json_str =array("CodRetorno"=> "99",									"Mensagem"=>"Erro acessando o serviço");		}	} else {		$json_str =array("CodRetorno"=> "99",									"Mensagem"=>"Erro acessando o serviço");	}	$jobj = json_encode($json_str);	echo "$jobj";}  catch (Exception $e) {	echo "Exceção pega: ",  $e->getMessage(), "\n";}
?>